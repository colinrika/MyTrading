<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“’ Balance and Trades</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0d1117; color: #e6edf3; margin: 0; padding: 20px; }
    h2 { color: #58a6ff; margin: 8px 0 12px 0; text-align: center; }

    .wrap { width: 92%; max-width: 1100px; margin: 0 auto; }
    .topBar { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    a.linkBtn { text-decoration: none; background: #58a6ff; color: #fff; font-weight: bold; border-radius: 10px; padding: 10px 14px; display: inline-block; }
    a.linkBtn:hover { filter: brightness(1.05); }

    .panel { background: #161b22; border: 2px solid #30363d; border-radius: 10px; padding: 12px; margin-bottom: 12px; overflow-x: auto; }
    .panel h3 { margin: 0 0 8px 0; font-size: 16px; }

    .kv { display: flex; justify-content: space-between; gap: 12px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .kv:last-child { border-bottom: none; }

    .muted { color: #8b949e; font-size: 12px; }
    .good { color: lightgreen; }
    .bad { color: #ff5555; }
    .warn { color: #ffcc00; }
    .priceHighlight { background: #1f6feb; color: #fff; font-weight: bold; }

    .tools { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input { border-radius: 10px; border: 1px solid #30363d; background: #0d1117; color: #e6edf3; padding: 10px 12px; width: 280px; }
    button { border-radius: 10px; border: none; padding: 10px 12px; font-weight: bold; cursor: pointer; background: #30363d; color: #e6edf3; }
    button:hover { filter: brightness(1.05); }
    button.danger { background: #7a1f1f; }
    button.primary { background: #58a6ff; color: #fff; }
    button:disabled { opacity: 0.45; cursor: not-allowed; }

    table { width: 100%; min-width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #30363d; }
    th { background: #0d1117; text-align: left; }

    .pager { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .linkBtnSmall { background: transparent; border: 1px solid #30363d; color: #58a6ff; padding: 6px 10px; border-radius: 8px; text-decoration: none; cursor: pointer; }
    .linkBtnSmall:hover { filter: brightness(1.1); }
    .modalBackdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 16px; width: 92%; max-width: 560px; }
    .modalHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .modalTitle { font-size: 16px; font-weight: bold; }
    .modalActions { display: flex; gap: 8px; align-items: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ðŸ“’ Balance and Trades</h2>

    <div class="topBar">
      <a class="linkBtn" href="/dashboard.html">â¬… Back to Dashboard</a>
      <div class="muted" id="updatedText"></div>
    </div>

    <div class="panel">
      <h3>Current Balance</h3>
      <div id="balanceLines">
        <div class="kv"><span class="muted">Loading balance</span><span class="muted">...</span></div>
      </div>
      <div class="muted" style="margin-top:8px;" id="availText"></div>
    </div>

    <div class="panel">
      <h3>Trades</h3>
      <div class="tools">
        <input id="searchBox" placeholder="Search pair, side, status" />
        <button id="btnSearch">Search</button>
        <button id="btnRefresh">Refresh</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Pair</th>
            <th>Side</th>
            <th>Status</th>
            <th>Entry</th>
            <th>Volume</th>
            <th>TP</th>
            <th>SL</th>
            <th>Current Price</th>
            <th>Open Orders</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tradeBody"></tbody>
      </table>

      <div class="pager">
        <div class="muted" id="pageText"></div>
        <div>
          <button id="btnPrev">Prev</button>
          <button id="btnNext">Next</button>
        </div>
      </div>

    </div>
  </div>

  <div class="modalBackdrop" id="ordersModal">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="ordersModalTitle">Open Orders</div>
        <div class="modalActions">
          <button id="refreshOrdersModal">Refresh</button>
          <button id="closeOrdersModal">Close</button>
        </div>
      </div>
      <div id="ordersModalBody" class="muted">Loading...</div>
    </div>
  </div>

  <script>
    const LIMIT = 10;
    let page = 1;
    let query = "";
    let redirecting = false;

    function apiUrl(p) { return window.location.origin + p; }

    function redirectToLoginOnce() {
      if (redirecting) return;
      redirecting = true;
      window.location.replace("/login.html");
    }

    async function getJson(url) {
      const r = await fetch(url, { credentials: "include" });
      const t = await r.text();
      let d = {};
      try { d = JSON.parse(t); } catch { d = { raw: t }; }

      if (!r.ok) {
        if (r.status === 401) {
          redirectToLoginOnce();
          throw new Error("Unauthorized");
        }
        throw new Error(d?.details || d?.error || ("Request failed " + r.status));
      }
      return d;
    }

    function fmt(n, dp) {
      const x = Number(n);
      if (!Number.isFinite(x)) return "";
      const d = Number.isFinite(dp) ? dp : 6;
      return x.toFixed(d);
    }

    function openModal() {
      document.getElementById("ordersModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("ordersModal").style.display = "none";
      document.getElementById("ordersModalBody").textContent = "";
    }

    async function postJson(url, payload) {
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        credentials: "include"
      });

      const t = await r.text();
      let d = {};
      try { d = JSON.parse(t); } catch { d = { raw: t }; }

      if (!r.ok) {
        if (r.status === 401) {
          redirectToLoginOnce();
          throw new Error("Unauthorized");
        }
        throw new Error(d?.details || d?.error || ("Request failed " + r.status));
      }
      return d;
    }

    function canCancel(status) {
      const s = String(status || "").toLowerCase();
      return s.includes("open") || s.includes("pending") || s.includes("submitted") || s.includes("partial");
    }

    function canClose(status) {
      const s = String(status || "").toLowerCase();
      if (s.includes("closed") || s.includes("canceled") || s.includes("cancelled") || s.includes("rejected")) return false;
      return true;
    }

    function normalizeAssetCode(code) {
      return String(code || "").replace(/^X|^Z/, "").toUpperCase();
    }

    function balanceForAsset(balance, assetCode) {
      const b = balance || {};
      const keys = Object.keys(b);
      if (!assetCode) return null;

      const exactKey = keys.find((k) => k.toUpperCase() === assetCode.toUpperCase());
      if (exactKey) return Number(b[exactKey]);

      const normalized = normalizeAssetCode(assetCode);
      const matchKey = keys.find((k) => normalizeAssetCode(k) === normalized);
      if (matchKey) return Number(b[matchKey]);

      return null;
    }

    async function refreshBalance() {
      try {
        const d = await getJson(apiUrl("/balance"));
        const wrap = document.getElementById("balanceLines");
        wrap.innerHTML = "";

        const b = d.balance || {};
        const zusd = b.ZUSD ?? b.USD ?? null;
        const row = document.createElement("div");
        row.className = "kv";
        row.innerHTML = "<span>ZUSD</span><span class='good'>" + (zusd !== null ? String(zusd) : "0") + "</span>";
        wrap.appendChild(row);

        const avail = Number(d.availableZusd);
        if (Number.isFinite(avail)) {
          document.getElementById("availText").textContent = "Available ZUSD for trading " + avail.toFixed(4);
        } else {
          document.getElementById("availText").textContent = "";
        }


        document.getElementById("updatedText").textContent = "Updated " + new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById("balanceLines").innerHTML =
          "<div class='kv'><span class='bad'>Balance error</span><span class='bad'>" + String(e.message) + "</span></div>";
        document.getElementById("availText").textContent = "";
      }
    }

    async function fetchCurrentPrices(pairs) {
      const uniq = Array.from(new Set(pairs.filter(Boolean)));
      if (!uniq.length) return {};

      const url = "https://api.kraken.com/0/public/Ticker?pair=" + encodeURIComponent(uniq.join(","));
      try {
        const r = await fetch(url);
        const d = await r.json();
        const result = d?.result || {};
        const map = {};

        for (const [key, val] of Object.entries(result)) {
          const price = Number(val?.c?.[0]);
          if (!Number.isFinite(price)) continue;
          map[key] = price;
          if (val?.altname) {
            map[val.altname] = price;
          }
        }
        return map;
      } catch (e) {
        return {};
      }
    }

    async function fetchPairMeta(pairs) {
      const uniq = Array.from(new Set(pairs.filter(Boolean)));
      if (!uniq.length) return {};

      const url = "https://api.kraken.com/0/public/AssetPairs?pair=" + encodeURIComponent(uniq.join(","));
      try {
        const r = await fetch(url);
        const d = await r.json();
        const result = d?.result || {};
        const map = {};

        for (const [key, val] of Object.entries(result)) {
          const base = String(val?.base || "");
          const quote = String(val?.quote || "");
          if (!base) continue;
          map[key] = { base, quote };
          if (val?.altname) {
            map[val.altname] = { base, quote };
          }
          if (val?.wsname) {
            map[val.wsname.replace("/", "")] = { base, quote };
          }
        }

        return map;
      } catch {
        return {};
      }
    }

    let modalPair = "";
    let modalTradeId = null;

    async function loadOpenOrders(pair, tradeId) {
      modalPair = pair;
      modalTradeId = tradeId;
      const modalBody = document.getElementById("ordersModalBody");
      modalBody.textContent = "Loading...";
      document.getElementById("ordersModalTitle").textContent = "Open Orders - " + pair;
      openModal();

      try {
        const resp = await getJson(apiUrl("/api/orders/open?pair=" + encodeURIComponent(pair) + "&tradeId=" + tradeId));
        if (resp.deleted) {
          modalBody.innerHTML = "<div class='bad'>No open orders. Trade removed.</div>";
          const row = document.querySelector("tr[data-trade-id='" + tradeId + "']");
          if (row) row.remove();
          return;
        }

        const items = resp.orders || [];
        if (!items.length) {
          modalBody.innerHTML = "<div class='muted'>No open orders.</div>";
          return;
        }

        const list = items.map((o) => {
          const txid = String(o?.txid || "");
          const side = String(o?.descr?.type || "").toUpperCase();
          const type = String(o?.descr?.ordertype || "");
          const price = o?.descr?.price ? Number(o.descr.price).toFixed(6) : "-";
          const vol = o?.vol ? Number(o.vol).toFixed(6) : "-";
          return (
            "<div class='kv'>" +
            "<span>" + side + " " + type + "</span>" +
            "<span>" + vol + " @ " + price + "</span>" +
            "<span><button class='danger' data-cancel-txid='" + txid + "'>Cancel</button></span>" +
            "</div>"
          );
        }).join("");

        modalBody.innerHTML = list;
        modalBody.querySelectorAll("button[data-cancel-txid]").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const txid = btn.getAttribute("data-cancel-txid");
            if (!txid) return;
            const ok = confirm("Cancel this order " + txid + " ?");
            if (!ok) return;
            btn.disabled = true;
            try {
              const r = await postJson(apiUrl("/api/order/cancel"), { txid });
              alert(r && r.canceled ? "Canceled" : "Cancel request sent");
              await loadOpenOrders(pair, tradeId);
            } catch (err) {
              alert(String(err.message || err));
              btn.disabled = false;
            }
          });
        });
      } catch (err) {
        modalBody.innerHTML = "<div class='bad'>" + String(err.message || err) + "</div>";
      }
    }

    async function refreshTrades() {
      const body = document.getElementById("tradeBody");
      body.innerHTML = "";

      let data;
      try {
        data = await getJson(apiUrl("/trades?page=" + page + "&pageSize=" + LIMIT + "&q=" + encodeURIComponent(query)));
      } catch (e) {
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='10' class='bad'>" + String(e.message) + "</td>";
        body.appendChild(tr);
        return;
      }

      const rawItems = data.items || [];
      const items = rawItems.filter((t) => canClose(t.status));
      const pairList = items.map((t) => String(t.pair || ""));
      const [priceMap, pairMetaMap, balanceResp] = await Promise.all([
        fetchCurrentPrices(pairList),
        fetchPairMeta(pairList),
        getJson(apiUrl("/balance"))
      ]);
      const balance = balanceResp?.balance || {};

      for (const t of items) {
        const tr = document.createElement("tr");

        const pair = String(t.pair || "");
        const currentPrice = Number(priceMap[pair]);
        const priceClass = Number.isFinite(currentPrice) ? "priceHighlight" : "muted";

        const pairMeta = pairMetaMap[pair];
        const baseAsset = pairMeta?.base || "";
        const baseBalance = balanceForAsset(balance, baseAsset);
        if (!Number.isFinite(baseBalance) || baseBalance <= 0) {
          continue;
        }

        const actionWrap = document.createElement("div");
        actionWrap.className = "actions";

        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "Cancel";
        cancelBtn.className = "danger";
        cancelBtn.disabled = !String(t.txid || "") || !canCancel(t.status);

        cancelBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const txid = String(t.txid || "");
          if (!txid) return;
          const ok = confirm("Cancel this order " + txid + " ?");
          if (!ok) return;

          cancelBtn.disabled = true;
          try {
            const r = await postJson(apiUrl("/api/order/cancel"), { txid });
            alert(r && r.canceled ? "Canceled" : "Cancel request sent");
            await refreshTrades();
          } catch (err) {
            alert(String(err.message || err));
            cancelBtn.disabled = false;
          }
        });

        const closeBtn = document.createElement("button");
        closeBtn.textContent = "Sell now";
        closeBtn.className = "primary";
        closeBtn.disabled = !canClose(t.status);

        closeBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const ok = confirm("Close this trade now using a market order?");
          if (!ok) return;

          closeBtn.disabled = true;
          try {
            const r = await postJson(apiUrl("/api/order/close"), { tradeId: Number(t.id) });
            alert(r && r.closed ? "Close sent" : "Close requested");
            await refreshTrades();
          } catch (err) {
            alert(String(err.message || err));
            closeBtn.disabled = false;
          }
        });

        actionWrap.appendChild(cancelBtn);
        actionWrap.appendChild(closeBtn);

        const openOrdersBtn = document.createElement("button");
        openOrdersBtn.className = "linkBtnSmall";
        openOrdersBtn.textContent = "View";
        openOrdersBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          loadOpenOrders(pair, t.id);
        });

        tr.innerHTML =
          "<td>" + (t.time ? new Date(t.time).toLocaleString() : (t.createdAt ? new Date(t.createdAt).toLocaleString() : "")) + "</td>" +
          "<td>" + pair + "</td>" +
          "<td>" + String(t.side || "") + "</td>" +
          "<td>" + String(t.status || "") + "</td>" +
          "<td>" + fmt(t.entryPrice ?? t.entry, 6) + "</td>" +
          "<td>" + fmt(t.volume, 6) + "</td>" +
          "<td>" + fmt(t.takeProfit ?? t.tp, 6) + "</td>" +
          "<td>" + fmt(t.stopLoss ?? t.sl, 6) + "</td>" +
          "<td class='" + priceClass + "'>" + (Number.isFinite(currentPrice) ? currentPrice.toFixed(6) : "") + "</td>" +
          "<td></td>" +
          "<td></td>";

        tr.setAttribute("data-trade-id", String(t.id || ""));
        tr.children[9].appendChild(openOrdersBtn);
        tr.children[10].appendChild(actionWrap);

        body.appendChild(tr);
      }

      const total = Number(data.total || 0);
      const totalPages = Math.max(1, Math.ceil(total / LIMIT));
      document.getElementById("pageText").textContent =
        "Page " + page + " of " + totalPages + "   Total " + total;

      document.getElementById("btnPrev").disabled = page <= 1;
      document.getElementById("btnNext").disabled = page >= totalPages;
    }

    document.getElementById("btnSearch").addEventListener("click", () => {
      query = String(document.getElementById("searchBox").value || "").trim();
      page = 1;
      refreshTrades();
    });

    document.getElementById("btnRefresh").addEventListener("click", () => {
      refreshBalance();
      refreshTrades();
    });

    document.getElementById("btnPrev").addEventListener("click", () => {
      page = Math.max(1, page - 1);
      refreshTrades();
    });

    document.getElementById("btnNext").addEventListener("click", () => {
      page = page + 1;
      refreshTrades();
    });

    refreshBalance();
    refreshTrades();
    setInterval(refreshBalance, 60000);
    setInterval(refreshTrades, 60000);

    document.getElementById("closeOrdersModal").addEventListener("click", closeModal);
    document.getElementById("refreshOrdersModal").addEventListener("click", () => {
      if (modalPair && modalTradeId) {
        loadOpenOrders(modalPair, modalTradeId);
      }
    });
    document.getElementById("ordersModal").addEventListener("click", (e) => {
      if (e.target.id === "ordersModal") closeModal();
    });
  </script>
</body>
</html>
