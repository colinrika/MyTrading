<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Strategy</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0d1117; color: #e6edf3; margin: 0; padding: 20px; }
    .wrap { width: 92%; max-width: 1100px; margin: 0 auto; }
    h2 { color: #58a6ff; margin: 8px 0 12px 0; text-align: center; }
    .topBar { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    a.linkBtn, button.linkBtn { text-decoration: none; background: #58a6ff; color: #fff; font-weight: bold; border-radius: 10px; padding: 10px 14px; display: inline-block; border: none; cursor: pointer; }
    .panel { background: #161b22; border: 2px solid #30363d; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .muted { color: #8b949e; font-size: 12px; }
    .good { color: lightgreen; font-weight: bold; }
    .bad { color: #ff5555; font-weight: bold; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > div { flex: 1 1 320px; }
    input, select { border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: #e6edf3; padding: 8px 10px; width: 100%; box-sizing: border-box; }
    button.primaryBtn { width: 100%; border: none; border-radius: 10px; padding: 14px 16px; font-weight: bold; cursor: pointer; background: #58a6ff; color: #fff; margin-top: 10px; font-size: 16px; }
    button.primaryBtn:disabled { opacity: 0.45; cursor: not-allowed; }
    canvas { width: 100%; height: 460px !important; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 id="title">Strategy</h2>

    <div class="topBar">
      <a class="linkBtn" href="/dashboard.html">Dashboard</a>
      <a class="linkBtn" href="/account.html">Trades</a>
      <button class="linkBtn" id="logoutBtn">Logout</button>
    </div>

    <div class="panel">
      <div class="muted" id="pairLine">Loading...</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <div class="muted">Trade amount USD</div>
          <input id="tradeAmount" type="number" value="5" />
          <div class="muted" style="margin-top:10px;">Or percent of USD</div>
          <select id="investSelect">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div>
          <div class="muted">Minimum check</div>
          <div id="minBox" class="muted" style="margin-top:6px;">Loading...</div>
          <div class="muted" style="margin-top:10px;">Status</div>
          <div id="statusBox" class="muted" style="margin-top:6px;">Ready</div>
          <button id="approveBtn" class="primaryBtn" disabled>Approve Strategy</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="muted">Chart placeholder</div>
      <canvas id="chart"></canvas>
      <div class="muted" style="margin-top:10px;">
        This page is the landing target for Telegram links. Your full strategy chart logic can be moved here next.
      </div>
    </div>
  </div>

  <script>
    function apiUrl(p) { return window.location.origin + p; }

    async function postJson(url, payload) {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        credentials: "include"
      });

      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!resp.ok) {
        const err = new Error(data?.details || data?.error || ("Request failed " + resp.status));
        err.payload = data;
        throw err;
      }
      return data;
    }

    async function getJson(url) {
      const resp = await fetch(url, { credentials: "include" });
      const text = await resp.text();
      let data = {};
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!resp.ok) {
        const err = new Error(data?.details || data?.error || ("Request failed " + resp.status));
        err.payload = data;
        throw err;
      }
      return data;
    }

    function getPairFromUrl() {
      const p = new URLSearchParams(window.location.search).get("pair");
      return p ? String(p) : "";
    }

    function prettyPair(pair) {
      return String(pair).replace("X", "").replace("ZUSD", "/USD");
    }

    async function doLogout() {
      try { await postJson("/api/logout", {}); } catch {}
      window.location.replace("/login.html");
    }

    document.getElementById("logoutBtn").addEventListener("click", doLogout);

    async function loadPairMeta(pair) {
      try {
        return await getJson(apiUrl("/pair-info?pair=" + encodeURIComponent(pair)));
      } catch {
        return { ordermin: null, costmin: null };
      }
    }

    async function loadUsdBalance() {
      const d = await getJson(apiUrl("/balance"));
      return Number(d?.balance?.ZUSD || 0);
    }

    function calcMinUsd(pairInfo, price) {
      const ordermin = Number(pairInfo?.ordermin || 0);
      const costmin = Number(pairInfo?.costmin || 0);
      const byVol = (ordermin > 0) ? (ordermin * price) : 0;
      const byCost = (costmin > 0) ? costmin : 0;
      const minUsd = Math.max(byVol, byCost);
      return (minUsd > 0) ? minUsd : 0;
    }

    async function refreshMinCheck(pair, pairInfo) {
      const statusBox = document.getElementById("statusBox");
      const minBox = document.getElementById("minBox");
      const approveBtn = document.getElementById("approveBtn");

      let price = 0;
      try {
        const t = await fetch("https://api.kraken.com/0/public/Ticker?pair=" + encodeURIComponent(pair));
        const j = await t.json();
        const result = j.result || {};
        const k = Object.keys(result)[0];
        price = Number(result?.[k]?.c?.[0] || 0);
      } catch {
        price = 0;
      }

      const usd = await loadUsdBalance();
      const amt = Number(document.getElementById("tradeAmount").value || 0);
      const pct = Number(document.getElementById("investSelect").value || 0);
      const invest = (amt > 0) ? amt : (usd * (pct / 100));

      const minUsd = (price > 0) ? calcMinUsd(pairInfo, price) : 0;

      const tooSmall = (minUsd > 0 && invest > 0 && invest < minUsd);
      const overBalance = invest > usd;

      minBox.innerHTML =
        "<div>USD balance <span class='good'>" + usd.toFixed(4) + "</span></div>" +
        "<div style='margin-top:6px;'>Invest <span class='" + (tooSmall || overBalance ? "bad" : "good") + "'>" + invest.toFixed(2) + "</span></div>" +
        (minUsd > 0 ? "<div style='margin-top:6px;'>Minimum <span class='" + (tooSmall ? "bad" : "good") + "'>" + minUsd.toFixed(2) + "</span></div>" : "<div style='margin-top:6px;'>Minimum unavailable</div>") +
        (price > 0 ? "<div style='margin-top:6px;'>Last price <span class='good'>" + price.toFixed(6) + "</span></div>" : "<div style='margin-top:6px;'>Price unavailable</div>");

      if (overBalance) statusBox.innerHTML = "<span class='bad'>Invest exceeds USD balance</span>";
      else if (tooSmall) statusBox.innerHTML = "<span class='bad'>Invest below minimum for this pair</span>";
      else statusBox.innerHTML = "<span class='good'>Ready</span>";

      approveBtn.disabled = overBalance || tooSmall || invest <= 0 || price <= 0;
      approveBtn.dataset.price = String(price || 0);
    }

    function buildBasicChart() {
      const ctx = document.getElementById("chart");
      if (!ctx) return;

      const labels = Array.from({ length: 30 }, (_, i) => String(i + 1));
      const data = labels.map((_, i) => Math.sin(i / 4) + 10);

      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Placeholder", data, borderWidth: 2, tension: 0.3, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    (async () => {
      const pair = getPairFromUrl();
      if (!pair) {
        document.getElementById("pairLine").textContent = "Missing pair in URL";
        document.getElementById("approveBtn").disabled = true;
        return;
      }

      document.getElementById("title").textContent = "Strategy " + prettyPair(pair);
      document.getElementById("pairLine").textContent = "Pair " + pair;

      const pairInfo = await loadPairMeta(pair);

      buildBasicChart();

      const refresh = () => refreshMinCheck(pair, pairInfo);

      document.getElementById("tradeAmount").addEventListener("input", refresh);
      document.getElementById("investSelect").addEventListener("change", refresh);

      await refresh();

      document.getElementById("approveBtn").addEventListener("click", async () => {
        const price = Number(document.getElementById("approveBtn").dataset.price || 0);
        const usd = await loadUsdBalance();

        const amt = Number(document.getElementById("tradeAmount").value || 0);
        const pct = Number(document.getElementById("investSelect").value || 0);
        const invest = (amt > 0) ? amt : (usd * (pct / 100));

        const payload = {
          pair,
          side: "buy",
          orderType: "limit",
          price,
          investUsd: invest
        };

        try {
          const result = await postJson(apiUrl("/trade"), payload);
          alert(String(result?.message || "Order sent"));
          window.location.href = "/account.html";
        } catch (e) {
          const p = e.payload || {};
          if (p && p.hint) alert(String(p.hint));
          else alert(String(e.message || "Order failed"));
        }
      });
    })();
  </script>
</body>
</html>
