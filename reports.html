<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“Š Reports</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #0d1117; color: #e6edf3; margin: 0; padding: 20px; }
    h2 { color: #58a6ff; margin: 8px 0 12px 0; text-align: center; }
    .wrap { width: 92%; max-width: 1100px; margin: 0 auto; }
    .topBar { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    a.linkBtn { text-decoration: none; background: #58a6ff; color: #fff; font-weight: bold; border-radius: 10px; padding: 10px 14px; display: inline-block; }
    a.linkBtn:hover { filter: brightness(1.05); }
    .panel { background: #161b22; border: 2px solid #30363d; border-radius: 10px; padding: 12px; margin-bottom: 12px; overflow-x: auto; }
    table { width: 100%; min-width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #30363d; }
    th { background: #0d1117; text-align: left; }
    .pager { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { border-radius: 10px; border: none; padding: 10px 12px; font-weight: bold; cursor: pointer; background: #30363d; color: #e6edf3; }
    button:hover { filter: brightness(1.05); }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    .good { color: lightgreen; }
    .bad { color: #ff5555; }
    .muted { color: #8b949e; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ðŸ“Š Reports</h2>

    <div class="topBar">
      <a class="linkBtn" href="/dashboard.html">â¬… Back to Dashboard</a>
      <a class="linkBtn" href="/account.html">ðŸ“’ Account</a>
    </div>

    <div class="panel">
      <h3>Last Sold Coins</h3>
      <table>
        <thead>
          <tr>
            <th>Pair</th>
            <th>Buy Time</th>
            <th>Sell Time</th>
            <th>Amount Bought (USD)</th>
            <th>Profit (USD)</th>
            <th>Loss (USD)</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
      </table>

      <div class="pager">
        <div class="muted" id="pageText"></div>
        <div>
          <button id="btnPrev">Prev</button>
          <button id="btnNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LIMIT = 10;
    let page = 1;
    let redirecting = false;

    function apiUrl(p) { return window.location.origin + p; }

    function redirectToLoginOnce() {
      if (redirecting) return;
      redirecting = true;
      window.location.replace("/login.html");
    }

    async function getJson(url) {
      const r = await fetch(url, { credentials: "include" });
      const t = await r.text();
      let d = {};
      try { d = JSON.parse(t); } catch { d = { raw: t }; }

      if (!r.ok) {
        if (r.status === 401) {
          redirectToLoginOnce();
          throw new Error("Unauthorized");
        }
        throw new Error(d?.details || d?.error || ("Request failed " + r.status));
      }
      return d;
    }

    function fmtUsd(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return "";
      return "$" + x.toFixed(2);
    }

    async function refreshReports() {
      const body = document.getElementById("reportBody");
      body.innerHTML = "";

      let data;
      try {
        data = await getJson(apiUrl("/api/reports/sold?page=" + page + "&pageSize=" + LIMIT));
      } catch (e) {
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='6' class='bad'>" + String(e.message) + "</td>";
        body.appendChild(tr);
        return;
      }

      const items = data.items || [];
      for (const row of items) {
        const profit = Number(row.profitUsd);
        const loss = Number(row.lossUsd);
        const profitClass = Number.isFinite(profit) && profit > 0 ? "good" : "muted";
        const lossClass = Number.isFinite(loss) && loss > 0 ? "bad" : "muted";

        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + String(row.pair || "") + "</td>" +
          "<td>" + (row.buyTime ? new Date(row.buyTime).toLocaleString() : "") + "</td>" +
          "<td>" + (row.sellTime ? new Date(row.sellTime).toLocaleString() : "") + "</td>" +
          "<td>" + fmtUsd(row.amountBoughtUsd) + "</td>" +
          "<td class='" + profitClass + "'>" + fmtUsd(profit) + "</td>" +
          "<td class='" + lossClass + "'>" + fmtUsd(loss) + "</td>";
        body.appendChild(tr);
      }

      const total = Number(data.total || 0);
      const totalPages = Math.max(1, Math.ceil(total / LIMIT));
      document.getElementById("pageText").textContent =
        "Page " + page + " of " + totalPages + "   Total " + total;

      document.getElementById("btnPrev").disabled = page <= 1;
      document.getElementById("btnNext").disabled = page >= totalPages;
    }

    document.getElementById("btnPrev").addEventListener("click", () => {
      page = Math.max(1, page - 1);
      refreshReports();
    });

    document.getElementById("btnNext").addEventListener("click", () => {
      page = page + 1;
      refreshReports();
    });

    refreshReports();
  </script>
</body>
</html>
